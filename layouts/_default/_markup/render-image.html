{{- $src := .Destination -}}
{{- $alt := .Text | htmlEscape -}}
{{- $title := .Title -}}

{{- /* locate image (page resource preferred, then /assets) */ -}}
{{- $img := .Page.Resources.GetMatch $src -}}
{{- if not $img -}}
  {{- $img = resources.Get $src -}}
{{- end -}}

{{- if $img -}}
  {{- $sizes     := "(max-width: 800px) 95vw, 800px" -}}
  {{- $quality   := 75 -}}
  {{- $widthList := slice 320 640 960 1280 -}}

  {{- $origExt := lower (strings.TrimPrefix "." (path.Ext $img.Name)) -}}

  {{- $srcsetWebp := slice -}}
  {{- $srcsetOrig := slice -}}

  {{- /* Build variants and also keep a sane fallback variant (e.g., 640w) */ -}}
  {{- $fallbackW   := 640 -}}
  {{- $fallbackVar := $img -}} {{/* default to original (won't be used if we set resized) */}}
  {{- range $w := $widthList -}}
    {{- $rOrig := $img.Resize (printf "%dx q%d" $w $quality) -}}
    {{- $rWebp := $img.Resize (printf "%dx webp q%d" $w $quality) -}}
    {{- $srcsetOrig = $srcsetOrig | append (printf "%s %dw" $rOrig.RelPermalink $w) -}}
    {{- $srcsetWebp = $srcsetWebp | append (printf "%s %dw" $rWebp.RelPermalink $w) -}}
    {{- if eq $w $fallbackW -}}
      {{- $fallbackVar = $rOrig -}}
    {{- end -}}
  {{- end -}}

  {{- /* Low-res placeholder for the wrapper */ -}}
  {{- $ph := $img.Resize "24x webp q20" -}}

  {{- /* Use the fallback variantâ€™s actual dimensions everywhere */ -}}
  {{- $fw := $fallbackVar.Width -}}
  {{- $fh := $fallbackVar.Height -}}

  <figure class="img-wrap" style="aspect-ratio: {{ $fw }} / {{ $fh }}; background:url('{{ $ph.RelPermalink }}') center/cover no-repeat;">
    <picture>
      <source type="image/webp" srcset="{{ delimit $srcsetWebp ", " }}" sizes="{{ $sizes }}">
      <source type="image/{{ $origExt }}" srcset="{{ delimit $srcsetOrig ", " }}" sizes="{{ $sizes }}">
      <img
        src="{{ $fallbackVar.RelPermalink }}"
        alt="{{ $alt }}"
        {{ with $title }}title="{{ . | htmlEscape }}"{{ end }}
        width="{{ $fw }}" height="{{ $fh }}"
        loading="lazy" decoding="async"
        style="display:block; width:100%; height:auto;"
      >
    </picture>
    {{- with $title -}}<figcaption>{{ . }}</figcaption>{{- end -}}
  </figure>
{{- else -}}
  {{/* External/static image passthrough (no processing) */}}
  <img src="{{ $src | safeURL }}" alt="{{ $alt }}"
       {{ with $title }}title="{{ . | htmlEscape }}"{{ end }}
       loading="lazy" decoding="async" style="display:block; width:100%; height:auto;">
{{- end -}}
